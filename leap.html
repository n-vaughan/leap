<script>
	TICKS = 0;

	// These will need tweaking
	PLAYER_WIDTH = 20;
	PLAYER_HEIGHT = 20;
	PLAT_WIDTH = 170;
	SPEED = 7;
	GRAVITY = -0.30;
	JUMP_VEL = 4;
	MAX_JUMP_TICKS = 45;
	MOUSE_IS_DOWN = false;

	// Set in setup()
	WIDTH = 0;
	HEIGHT = 0;
	PILLARS = null;
	PLAYER = null;



	// Width of the playing field; max height of a pillar
	function Pillars(width, height) {
		this.width = width;
		this.height = height;
		var heights = new Array(((width / PLAT_WIDTH) | 0) + 2);
		var offset = 0;

		// init heights array
		for(var i = 0; i < heights.length; i++) {
			heights[i] = Math.random() * this.height;
		}

		this.getHeight = function(x) {
			return heights[((x + offset) / PLAT_WIDTH) | 0];
		};
		this.leftBound = function(x) {
			var trueX = x + offset;
			return (((trueX / PLAT_WIDTH) | 0) * PLAT_WIDTH) - offset;
		};
		this.move = function(dist) {
			offset += dist;

			// Can we skip shifting around the array of pillar heights?
			if(offset < PLAT_WIDTH) {
				return;
			}

			// Don't have to worry about modulo b/c this is called every tick,
			// and X speed is much lower than platform width
			offset -= PLAT_WIDTH;
			heights.shift();
			heights.push(Math.random() * this.height);
		};
		this.draw = function() {
			CONTEXT.fillStyle = "rgb(0, 0, 0)";
			CONTEXT.save();
				CONTEXT.translate(-offset, 0);
				for(var i = 0; i < heights.length; i++) {
					CONTEXT.fillRect(0, 0, PLAT_WIDTH, heights[i]);
					CONTEXT.translate(PLAT_WIDTH, 0);
				}
			CONTEXT.restore();
		};
	}

	// x, y correspond to location of bottom right corner
	function Player(x, y) {
		this.x = x;
		this.y = y;
		this.grounded = true;
		this.velx = SPEED;
		this.vely = 0;
		this.jumps = 0;

		this.tick = function() {
			if(MOUSE_IS_DOWN)
				this.jump();

			// Save to see how far we travel
			var oldX = this.x;

			// Update vel, then positions
			this.vely += GRAVITY;
			this.x += this.velx;
			this.y += this.vely;

			var pillarHeightR = PILLARS.getHeight(this.x);
			var pillarHeightL = PILLARS.getHeight(this.x - PLAYER_WIDTH);
			var pillarHeight = Math.max(pillarHeightL, pillarHeightR);

			// Have we fallen onto a pillar?
			// (check both left and right corners of Player)
			if(this.y <= pillarHeightL) {
				this.y = pillarHeightL;
				this.grounded = true;
				this.vely = 0;
				this.jumps = 0;
			} else {
				this.grounded = false;
			}

			// Are we pushing into a pillar?
			if(this.y < pillarHeightR && this.y >= pillarHeightL) {
				this.x = PILLARS.leftBound(this.x);
			}

			// Finally, update the pillar offset with our actual X movement
			PILLARS.move(this.x - oldX);

			// Keep it in the middle, tbh
			this.x = oldX;
		};

		this.jump = function() {
			// If you aren't grounded, you must be executing a jump to continue jumping
			// In the opposite situation (grounded, or non-zero jumps), continued jumping allowed
			if(( ! this.grounded) && this.jumps == 0)
				return;

			// ... unless you've reached the max jump height
			if(this.jumps == MAX_JUMP_TICKS) {
				// Prevent continued jumping unless grounded
				this.jumps = 0;
				return;
			}

			// If we reach this point, we are allowed to jump.
			// To "jump" is to set the velocity, rather than accel up
			this.vely = JUMP_VEL;
			this.jumps++;
		};

		this.draw = function() {
			CONTEXT.fillStyle = "rgb(64, 192, 192)";
			CONTEXT.fillRect(((WIDTH / 2) | 0) - PLAYER_WIDTH, this.y, PLAYER_WIDTH, PLAYER_HEIGHT);
		};
	}


	function tick() {
		TICKS++;

		PLAYER.tick();

		// Draw background
		CONTEXT.fillStyle = "rgb(255, 255, 255)";
		CONTEXT.fillRect(0, 0, WIDTH, HEIGHT);

		// Draw pillars
		PILLARS.draw();
		// Draw player
		PLAYER.draw();



		// Score
		//CONTEXT.fillStyle = "rgb(0, 0, 0)";
		//CONTEXT.font = "30px Sans";
		//CONTEXT.fillText("Score: " + SCORE, 10, 40);
		window.requestAnimationFrame(tick);
	}

	function mouseDown() {
		MOUSE_IS_DOWN = true;
	}
	function mouseUp() {
		MOUSE_IS_DOWN = false;
		PLAYER.jumps = 0;
	}

	function setup() {
		var canvas = document.getElementById('c');
		CONTEXT = canvas.getContext('2d');

		WIDTH = canvas.width = document.body.scrollWidth - 40;
		HEIGHT = canvas.height = document.body.scrollHeight - 100;

		CONTEXT.translate(0, HEIGHT);
		CONTEXT.scale(1, -1); // swap y-coordinates for sanity

		canvas.onmousedown = mouseDown;
		canvas.onmouseup = mouseUp;

		PILLARS = new Pillars(WIDTH, 200);
		var startX = (WIDTH / 2) | 0;
		PLAYER = new Player(startX, PILLARS.getHeight(startX));

		tick();
		//setInterval(tick, 100);
	}
</script>

<body onload="setup()" oncontextmenu="return false;">
	Click to jump; hold to jump higher! <br />
	<canvas id=c width=1000 height=600></canvas>
</body>
